#include "pch.h"
#include <cassert>
#include "Game/CommonResources.h"
#include "DeviceResources.h"
#include "Libraries/MyLib/DebugString.h"
#include "Libraries/MyLib/Math.h"

#include "Game/Enemy/Enemy.h"
#include "Game/Player/Player.h"
#include "Game/Weapon/Cudgel/Cudgel.h"
#include "Game/Enemy/States/Header/Enemy_Attacking.h"

// --------------------------------------
// コンストラクタ
// --------------------------------------
Enemy_Attacking::Enemy_Attacking(Enemy* enemy)
	:
	m_angle{},
	m_enemy(enemy),
	m_totalSeconds{}
{
}

// --------------------------------------
// デストラクタ
// --------------------------------------
Enemy_Attacking::~Enemy_Attacking()
{
}


// --------------------------------------
// 初期化処理
// --------------------------------------
void Enemy_Attacking::Initialize()
{
}


// --------------------------------------
// ステート更新処理（in）
// --------------------------------------
void Enemy_Attacking::PreUpdate()
{
	// 経過時間を初期化
	m_totalSeconds = 0.0f;
	// 武器のステートを変更
	auto cudgel = m_enemy->GetPlayScene()->GetCudgel();
	cudgel->ChangeState(cudgel->GetAttacking());

	// 顔のステートを変更
	m_enemy->SetFace(m_enemy->GetFaceAttacking());
}


// --------------------------------------
// 更新処理
// --------------------------------------
void Enemy_Attacking::Update(const float& elapsedTime)
{
	// 経過時間を加算
	m_totalSeconds += elapsedTime;

	// プレイヤーの座標を取得
	DirectX::SimpleMath::Vector3 playerPos = m_enemy->GetPlayScene()->GetPlayer()->GetPosition();
	// 敵の座標を取得
	DirectX::SimpleMath::Vector3 parentPos = m_enemy->GetPosition();
	// 敵から見たプレイヤーの位置を計算する
	m_angle = Math::CalculationAngle(parentPos, playerPos);

	// 攻撃中まではプレイヤーを追尾するようにする
	if (m_totalSeconds <= Cudgel_Attacking::ATTACK_TIME)
	{
		// プレイヤーを追尾
		m_enemy->SetAngle(m_angle);
	}

	if (m_totalSeconds >= TOTAL_TIME)
	{
		m_enemy->ChangeState(m_enemy->GetEnemyIdling());	// 待機状態に遷移
	}
}


// --------------------------------------
// ステート変更処理(out)
// --------------------------------------
void Enemy_Attacking::PostUpdate()
{
	// 武器のステートを変更する
	auto cudgel = m_enemy->GetPlayScene()->GetCudgel();
	cudgel->ChangeState(cudgel->GetIdling());

	// 顔のステートを変更
	m_enemy->SetFace(m_enemy->GetFaceIdling());
}


// --------------------------------------
// 終了処理
// --------------------------------------
void Enemy_Attacking::Finalize()
{
}